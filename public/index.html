<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Lumen Condenser MVP</title>
  <style>
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; padding: 16px; }
    .row { display: flex; gap: 16px; }
    .panel { border: 1px solid #ddd; border-radius: 10px; padding: 12px; flex: 1; }
    button { margin: 4px; padding: 8px 10px; border-radius: 8px; border: 1px solid #ccc; background: white; cursor: pointer; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    pre { background: #0b1020; color: #d8e1ff; padding: 12px; border-radius: 10px; overflow: auto; height: 320px; }
    .muted { color: #666; }
    code { background: #f2f2f2; padding: 2px 6px; border-radius: 6px; }
  </style>
</head>
<body>
  <h2>Lumen Condenser Online MVP (2인 방)</h2>
  <div class="muted">같은 URL의 <code>?room=abc</code> 값을 맞추면 같은 방으로 들어갑니다.</div>
  <div id="status" style="margin:8px 0;"></div>

  <div class="row">
    <div class="panel">
      <h3>내 정보</h3>
      <div id="me"></div>
      <h4>내 손패 (클릭해서 레디 제출)</h4>
      <div id="hand"></div>
    </div>
    <div class="panel">
      <h3>상대 정보</h3>
      <div id="opp"></div>
      <h4>이벤트 로그</h4>
      <pre id="log"></pre>
    </div>
  </div>

<script>
  const params = new URLSearchParams(location.search);
  const room = params.get("room") || "test";

  const proto = location.protocol === "https:" ? "wss" : "ws";
  const ws = new WebSocket(`${proto}://${location.host}`);

  let playerId = null;
  let submitted = false;

  const $status = document.getElementById("status");
  const $me = document.getElementById("me");
  const $opp = document.getElementById("opp");
  const $hand = document.getElementById("hand");
  const $log = document.getElementById("log");

  function log(line) {
    $log.textContent += line + "\n";
    $log.scrollTop = $log.scrollHeight;
  }

  ws.onopen = () => {
    $status.textContent = `연결됨. room=${room}`;
    ws.send(JSON.stringify({ type: "join", room }));
  };

  ws.onmessage = (ev) => {
    const msg = JSON.parse(ev.data);

    if (msg.type === "joined") {
      playerId = msg.playerId;
      log(`[JOIN] you are ${playerId} in room=${msg.room}`);
      return;
    }

    if (msg.type === "error") {
      log(`[ERROR] ${msg.message}`);
      return;
    }

    if (msg.type === "events") {
      msg.events.forEach(e => log(JSON.stringify(e)));
      return;
    }

    if (msg.type === "state") {
      if (msg.view?.waiting) {
        $me.textContent = "상대 기다리는 중...";
        $opp.textContent = "";
        $hand.innerHTML = "";
        return;
      }

      const view = msg.view;
      submitted = !!view.me.submitted;

      $me.textContent = `HP=${view.me.hp} / FP=${view.me.fp} / Phase=${view.phase} / submitted=${view.me.submitted} / list=${view.me.listCount}`;
      $opp.textContent = `HP=${view.opp.hp} / FP=${view.opp.fp} / hand=${view.opp.handCount} / submitted=${view.opp.submitted} / list=${view.opp.listCount}`;

      $hand.innerHTML = "";
      msg.myHandCards.forEach(c => {
        const b = document.createElement("button");
        b.textContent = `${c.name} (${c.id})`;
        b.disabled = submitted || view.phase !== "READY";
        b.onclick = () => ws.send(JSON.stringify({ type: "select", cardId: c.id }));
        $hand.appendChild(b);
      });
    }
  };

  ws.onclose = () => { $status.textContent = "연결 종료"; };
</script>
</body>
</html>
